import nltk
import string
from nltk import CFG, ChartParser
from nltk.draw import draw_trees

import pymorphy3


nltk.download('punkt')
nltk.download('punkt_tab')

morph = pymorphy3.MorphAnalyzer()

# 1
sentences = [
    "мама испекла вкусный пирог",
    "я вчера получил двойку по математике",
    "большая собака громко лает",
    "папа пришел с работы и принес шоколадку",
    "таксист попал в аварию",
    "листья на деревьях пожелтели"
]


# 2 - Токенизация и очистка от пунктуациии
def preprocess_sentence(sentence):
    tokens = nltk.word_tokenize(sentence, language='russian')
    tokens_clean = [token for token in tokens if token not in string.punctuation]
    return tokens_clean


# Доп - Определение части речи pymorphy2
def get_pymorphy_pos(token: str) -> str:
    p = morph.parse(token.lower())
    if not p:
        return "UNKN"
    pos = p[0].tag.POS
    return pos if pos else "UNKN"


# Доп - Подписываем части речи в дереве
def annotate_tree_leaves_with_pos(tree):
    # обходим позиции всех листьев и заменяем их
    for leaf_pos in tree.treepositions('leaves'):
        word = tree[leaf_pos]
        pos = get_pymorphy_pos(word)
        tree[leaf_pos] = f"{word}/{pos}"
    return tree


processed_sentences = [preprocess_sentence(sent) for sent in sentences]

print("Обработанные предложения:")
for i, sent in enumerate(processed_sentences, 1):
    print(f"{i}: {sent}")

print("\nPOS-теги (pymorphy2) для каждого предложения:")
for i, tokens in enumerate(processed_sentences, 1):
    pos_tags = [(t, get_pymorphy_pos(t)) for t in tokens]
    print(f"{i}: {pos_tags}")


# 3 Контекстно-свободная грамматика для русского языка с АНГЛИЙСКИМИ метками
grammar = nltk.CFG.fromstring("""
    ПРЕДЛ -> ИГ СГ | СГ | ПРЕДЛ СОЮЗ ПРЕДЛ

    # Именная группа
    ИГ -> СУЩ | ПРИЛ ИГ | ИГ ПРИЛ | ИГ ПГ | МЕСТ | ПРИЛ СУЩ | СУЩ СУЩ | ИГ СОЮЗ ИГ

    # Глагольная группа
    СГ -> ГЛАГ | ГЛАГ ИГ | ГЛАГ ПГ | НАРЕЧ СГ | СГ НАРЕЧ | СГ ПГ | ГЛАГ НАРЕЧ
    СГ -> ГЛАГ ИГ ПГ | СГ СОЮЗ СГ

    # Предложная группа
    ПГ -> ПРЕДЛ ИГ

    # Части речи
    СУЩ -> 'папа' | 'работы' | 'шоколадку' | 'таксист' | 'аварию' | 'листья' | 'деревьях' | 'двойку' | 'математике' | 'мама' | 'пирог' | 'собака'
    ГЛАГ -> 'получил' | 'пришел' | 'принес' | 'попал' | 'пожелтели' | 'испекла' | 'лает'
    ПРИЛ -> 'вкусный' | 'большая'
    НАРЕЧ -> 'вчера' | 'громко'
    МЕСТ -> 'я'
    ПРЕДЛ -> 'на' | 'по' | 'с' | 'в'
    СОЮЗ -> 'и'
""")


#Подзадача 1: реализовать грамматику с разбиением по членам предложения
grammar_1 = nltk.CFG.fromstring("""
    # Стартовый символ с союзами
    ПРЕДЛ -> ПОДЛЕЖАЩАЯ_ЧАСТЬ СКАЗУЕМАЯ_ЧАСТЬ | СКАЗУЕМАЯ_ЧАСТЬ | ПРЕДЛ СОЮЗ ПРЕДЛ

    # Подлежащая часть с союзами
    ПОДЛЕЖАЩАЯ_ЧАСТЬ -> ПОДЛЕЖАЩЕЕ | ПОДЛЕЖАЩАЯ_ЧАСТЬ СОЮЗ ПОДЛЕЖАЩАЯ_ЧАСТЬ
    ПОДЛЕЖАЩЕЕ -> СУЩ_ПОДЛ | ПРИЛ_ОПРЕД СУЩ_ПОДЛ | МЕСТ_ПОДЛ

    # Сказуемая часть с союзами - ДЕЛАЕМ ПОРЯДОК ГИБКИМ
    СКАЗУЕМАЯ_ЧАСТЬ -> СКАЗУЕМОЕ | СКАЗУЕМОЕ ДОПОЛНЕНИЯ | СКАЗУЕМОЕ ОБСТОЯТЕЛЬСТВА | ОБСТОЯТЕЛЬСТВА СКАЗУЕМОЕ | СКАЗУЕМОЕ ДОПОЛНЕНИЯ ОБСТОЯТЕЛЬСТВА | ОБСТОЯТЕЛЬСТВА СКАЗУЕМОЕ ДОПОЛНЕНИЯ | СКАЗУЕМАЯ_ЧАСТЬ СОЮЗ СКАЗУЕМАЯ_ЧАСТЬ
    СКАЗУЕМОЕ -> ГЛАГ_СКАЗ

    # Дополнения и обстоятельства
    ДОПОЛНЕНИЯ -> ДОПОЛНЕНИЕ | ДОПОЛНЕНИЯ ДОПОЛНЕНИЕ
    ДОПОЛНЕНИЕ -> СУЩ_ДОП | ПРИЛ_ОПРЕД СУЩ_ДОП | ПРЕДЛОГ СУЩ_ДОП
    ОБСТОЯТЕЛЬСТВА -> ОБСТОЯТЕЛЬСТВО | ОБСТОЯТЕЛЬСТВА ОБСТОЯТЕЛЬСТВО
    ОБСТОЯТЕЛЬСТВО -> НАРЕЧ_ОБСТ | ПРЕДЛОГ СУЩ_ОБСТ

    # Части речи - РАСШИРЯЕМ СЛОВАРЬ
    СУЩ_ПОДЛ -> 'мама' | 'собака' | 'папа' | 'таксист' | 'листья' | 'я'
    СУЩ_ДОП -> 'пирог' | 'двойку' | 'шоколадку' | 'аварию' | 'работы' | 'математике' | 'деревьях'
    СУЩ_ОБСТ -> 'работы' | 'деревьях' | 'математике'
    МЕСТ_ПОДЛ -> 'я'

    ГЛАГ_СКАЗ -> 'испекла' | 'получил' | 'лает' | 'пришел' | 'принес' | 'попал' | 'пожелтели'
    ПРИЛ_ОПРЕД -> 'вкусный' | 'большая'
    НАРЕЧ_ОБСТ -> 'вчера' | 'громко'
    ПРЕДЛОГ -> 'в' | 'по' | 'на' | 'с'
    СОЮЗ -> 'и'
""")


grammar_2 = nltk.CFG.fromstring("""
    # Стартовый символ
    ПРЕДЛ -> ФРЕЙМ | ФРЕЙМ СОЮЗ ФРЕЙМ

    # Ситуационный фрейм: действие и его участники
    ФРЕЙМ -> ДЕЙСТВИЕ | ДЕЙСТВИЕ УЧАСТНИКИ | УЧАСТНИКИ ДЕЙСТВИЕ | УЧАСТНИКИ ДЕЙСТВИЕ УЧАСТНИКИ
    УЧАСТНИКИ -> УЧАСТНИК | УЧАСТНИКИ УЧАСТНИК

    # Типы участников (ролей)
    УЧАСТНИК -> ДЕЙСТВУЮЩИЙ_ЛИЦО | ОБЪЕКТ_ДЕЙСТВИЯ | АДРЕСАТ | ИНСТРУМЕНТ | МЕСТО | ВРЕМЯ | СПОСОБ | СИТУАЦИЯ

    # Определения ролей
    ДЕЙСТВУЮЩИЙ_ЛИЦО -> ИГ_ДЕЙСТВУЮЩИЙ
    ОБЪЕКТ_ДЕЙСТВИЯ -> ИГ_ОБЪЕКТ
    АДРЕСАТ -> ИГ_АДРЕСАТ
    ИНСТРУМЕНТ -> ПГ_ИНСТРУМЕНТ
    МЕСТО -> ПГ_МЕСТО
    ВРЕМЯ -> НАРЕЧ_ВРЕМЯ
    СПОСОБ -> НАРЕЧ_СПОСОБ
    СИТУАЦИЯ -> ПГ_СИТУАЦИЯ

    # Глагольная группа (действие)
    ДЕЙСТВИЕ -> ГЛАГОЛ | ГЛАГОЛ НАРЕЧ_СПОСОБ

    # Именные группы для ролей
    ИГ_ДЕЙСТВУЮЩИЙ -> СУЩ_ДЕЙСТВУЮЩИЙ | ПРИЛ_ОПРЕД СУЩ_ДЕЙСТВУЮЩИЙ | МЕСТ_ДЕЙСТВУЮЩИЙ
    ИГ_ОБЪЕКТ -> СУЩ_ОБЪЕКТ | ПРИЛ_ОПРЕД СУЩ_ОБЪЕКТ
    ИГ_АДРЕСАТ -> СУЩ_АДРЕСАТ | ПРИЛ_ОПРЕД СУЩ_АДРЕСАТ

    # Предложные группы
    ПГ_ИНСТРУМЕНТ -> ПРЕДЛОГ_ИНСТРУМЕНТ СУЩ_ИНСТРУМЕНТ
    ПГ_МЕСТО -> ПРЕДЛОГ_МЕСТО СУЩ_МЕСТО
    ПГ_СИТУАЦИЯ -> ПРЕДЛОГ_МЕСТО СУЩ_ОБЪЕКТ

    # Части речи
    ГЛАГОЛ -> 'испекла' | 'получил' | 'пришел' | 'принес' | 'попал' | 'пожелтели' | 'лает'

    СУЩ_ДЕЙСТВУЮЩИЙ -> 'мама' | 'папа' | 'таксист' | 'листья' | 'я' | 'собака'
    СУЩ_ОБЪЕКТ -> 'пирог' | 'двойку' | 'шоколадку' | 'аварию'
    СУЩ_АДРЕСАТ -> 'папа' | 'мама'
    СУЩ_ИНСТРУМЕНТ -> 'работы'
    СУЩ_МЕСТО -> 'деревьях' | 'математике'

    ПРИЛ_ОПРЕД -> 'вкусный' | 'большая'

    НАРЕЧ_ВРЕМЯ -> 'вчера'
    НАРЕЧ_СПОСОБ -> 'громко'

    # Предлоги
    ПРЕДЛОГ_МЕСТО -> 'на' | 'по' | 'в'
    ПРЕДЛОГ_ИНСТРУМЕНТ -> 'с' | 'в'

    СОЮЗ -> 'и'
""")


parser_1 = ChartParser(grammar_1)
parser_2 = ChartParser(grammar_2)

print("\n" + "=" * 60)
print("ПОДЗАДАЧА 1")
print("=" * 60)

for i, tokens in enumerate(processed_sentences, 1):
    print(f"\nПредложение {i}: {' '.join(tokens)}")
    print("-" * 50)
    try:
        trees = list(parser_1.parse(tokens))
        if trees:
            print("✓ Разбор успешен!")
            tree = trees[0]

            annotate_tree_leaves_with_pos(tree)

            draw_trees(tree)
        else:
            print("✗ Не удалось разобрать предложение")
    except Exception as e:
        print(f"✗ Ошибка: {e}")

print("\n" + "=" * 60)
print("ПОДЗАДАЧА 2:")
print("=" * 60)

for i, tokens in enumerate(processed_sentences, 1):
    print(f"\nПредложение {i}: {' '.join(tokens)}")
    print("-" * 50)
    try:
        trees = list(parser_2.parse(tokens))
        if trees:
            print("✓ Разбор успешен!")
            tree = trees[0]

            annotate_tree_leaves_with_pos(tree)

            draw_trees(tree)
        else:
            print("✗ Не удалось разобрать предложение")
    except Exception as e:
        print(f"✗ Ошибка: {e}")
