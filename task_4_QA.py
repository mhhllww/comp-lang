from typing import Tuple
from deeppavlov import build_model


CONTEXTS = [
    "Компания «НордСофт» основана в 2016 году в городе Казань.",
    "Основной продукт «НордСофт» называется «СеверCRM».",
    "«СеверCRM» используется для управления продажами и клиентской базой.",
    "В «НордСофт» работает 120 сотрудников.",
    "В компании есть отделы разработки, тестирования и аналитики.",
    "Главный язык бэкенда в «НордСофт» — Python.",
    "Фронтенд в «НордСофт» пишут на TypeScript.",
    "Для хранения данных «СеверCRM» используется PostgreSQL.",
    "Система логирования в «НордСофт» построена на Elasticsearch.",
    "CI/CD в «НордСофт» реализован с помощью GitLab CI.",
    "Релизы продукта «СеверCRM» выходят раз в две недели.",
    "Технический директор компании «НордСофт» — Илья Соколов.",
    "Компания «ОрионЛаб» специализируется на мобильных приложениях для доставки еды.",
    "Флагманское приложение «ОрионЛаб» называется «OrionFood».",
    "Основной язык мобильной разработки в «ОрионЛаб» — Kotlin.",
    "В «ОрионЛаб» используется база данных MongoDB для хранения пользовательских профилей.",
    "Команда DevOps в «ОрионЛаб» разворачивает сервисы в Kubernetes.",
    "Компания «ВегаТех» разрабатывает сервисы для распознавания речи.",
    "Главная модель распознавания речи в «ВегаТех» называется «VegaASR».",
    "Точность модели «VegaASR» на тестовом наборе составляет 92 процента."
]


def decide_qa_answer(answer: str, confidence: float, threshold: float = 0.98) -> Tuple[str, float]:
    if not answer or answer.strip() == "":
        return "Не могу ответить", confidence

    if confidence < threshold:
        return "Не могу ответить", confidence

    return answer, confidence


def main(threshold: float = 0.98):
    # склеиваем в одно большое поле контекста
    full_context = " ".join(CONTEXTS)

    # загружаем модель
    qa_model = build_model("squad_ru_bert", download=True, install=True)

    print(f"Текущий порог уверенности: {threshold}\n")

    test_questions = [
    "В каком году была основана компания НордСофт",
    "В каком городе основана компания НордСофт",
    "Сколько сотрудников работает в компании НордСофт",
    "Как называется основной продукт компании НордСофт",
    "Для чего используется СеверCRM",
    "Какой язык используется для бэкенда в НордСофт",
    "На каком языке пишут фронтенд в НордСофт",
    "Какая база данных используется в СеверCRM",
    "Как реализован CI/CD в НордСофт",
    "Как часто выходят релизы СеверCRM",
    "Кто является техническим директором НордСофт",
    "На чем специализируется компания ОрионЛаб",
    "Как называется флагманское приложение ОрионЛаб",
    "Какой язык мобильной разработки в ОрионЛаб",
    "Для чего ОрионЛаб использует MongoDB",
    "В чем разворачиваются сервисы ОрионЛаб",
    "Что разрабатывает компания ВегаТех",
    "Как называется модель распознавания речи в ВегаТех",
    "Какова точность модели VegaASR",
    # вопросы, на которые нет ответа в контексте (должно быть "Не могу ответить")
    "Какой адрес офиса компании НордСофт",
    "Какое облако использует ОрионЛаб",
    "Какой номер версии у последнего релиза СеверCRM",
    "Сколько пользователей у приложения OrionFood"
]

    for question in test_questions:
        print(f"Вопрос: {question}")

        # проверка на слишком короткие вопросы
        if len(question.split()) < 2:
            print("Уверенность модели: 0.0")
            print("Итоговый ответ: Не могу ответить")
            print("-" * 40)
            continue

        answers, starts, confidences = qa_model([full_context], [question])

        confidence = float(confidences[0])
        answer = answers[0]

        final_answer, used_conf = decide_qa_answer(
            answer, confidence, threshold=threshold
        )

        print(f"Уверенность модели: {confidence}")
        print(f"Итоговый ответ: {final_answer}")
        print("-" * 40)


if __name__ == "__main__":
    main()
